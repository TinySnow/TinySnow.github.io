# 中断系统

## 复习

1. 了解了CPU的基本工作原理
2. 掌握了总线系统的基础知识
3. 理解了指令执行过程

## TL;DR

- 中断是处理异步事件的机制
- 中断分为硬件中断和软件中断
- 中断处理需要保存和恢复现场
- 中断优先级决定处理顺序

## 正文

### 中断的基本概念

#### 1. 中断定义

1. **本质特征**：
   - 异步事件处理机制
   - 打断当前程序执行
   - 自动保存和恢复现场

2. **基本流程**：
   ```
   正常执行 -> 中断请求 -> 保存现场 ->
   中断处理 -> 恢复现场 -> 继续执行
   ```

#### 2. 中断类型

1. **硬件中断**：
   - 外设请求（键盘、鼠标）
   - 时钟中断
   - 硬件错误

2. **软件中断**：
   - 系统调用
   - 程序异常
   - 陷阱指令

### 中断处理机制

#### 1. 中断响应

1. **中断检测**：
   ```
   每条指令执行结束时：
   IF 中断标志使能 AND 有中断请求 THEN
       开始中断响应
   ELSE
       执行下一条指令
   ```

2. **中断屏蔽**：
   ```
   中断屏蔽字：  1010 1100
   中断请求：    0010 0100
   实际响应：    0010 0100
   （1表示屏蔽，0表示允许）
   ```

#### 2. 中断处理流程

1. **保存现场**：
   ```assembly
   PUSH PC      ; 保存程序计数器
   PUSH PSW     ; 保存状态字
   PUSH R1      ; 保存通用寄存器
   ...
   ```

2. **中断服务**：
   ```
   1. 获取中断向量
   2. 跳转到服务程序
   3. 执行服务程序
   4. 返回主程序
   ```

3. **恢复现场**：
   ```assembly
   POP R1       ; 恢复通用寄存器
   ...
   POP PSW      ; 恢复状态字
   POP PC       ; 恢复程序计数器
   IRET         ; 中断返回
   ```

### 中断向量表

#### 1. 基本结构

1. **向量表组织**：
   ```
   地址        中断服务程序
   0x00000000  复位处理程序
   0x00000004  未定义指令
   0x00000008  系统调用
   0x0000000C  预取指令出错
   ...
   ```

2. **向量表项**：
   ```
   +------------+----------------+
   | 入口地址   | 初始状态字PSW  |
   +------------+----------------+
   ```

#### 2. 中断优先级

1. **硬件优先级**：
   ```
   高  复位中断
       不可屏蔽中断
       硬件错误
       外设中断
   低  软件中断
   ```

2. **优先级处理**：
   ```
   当多个中断同时到达：
   IF 新中断优先级 > 当前中断优先级 THEN
       保存当前中断现场
       处理新中断
   ELSE
       将新中断加入等待队列
   ```

### 实际应用示例

#### 1. 键盘中断处理

1. **中断流程**：
   ```
   键盘按键 -> 产生中断 -> CPU响应 ->
   读取扫描码 -> 转换字符 -> 存入缓冲
   ```

2. **代码示例**：
   ```c
   void keyboard_interrupt_handler() {
       unsigned char scancode = in_byte(0x60);
       char ascii = convert_scancode(scancode);
       if (ascii) {
           buffer_put(ascii);
       }
   }
   ```

#### 2. 时钟中断

1. **基本功能**：
   ```
   时钟中断 -> 更新系统时间 ->
   检查定时器 -> 进程调度
   ```

2. **实现示例**：
   ```c
   void timer_interrupt_handler() {
       ticks++;
       if (ticks % TIME_SLICE == 0) {
           schedule();  // 进程调度
       }
       update_system_time();
   }
   ```

### 中断性能优化

#### 1. 响应时间优化

1. **快速中断**：
   - 最小化保存现场
   - 关键代码优化
   - 使用专用寄存器

2. **中断分层**：
   ```
   顶半部（快速处理）：
   - 最小必要处理
   - 硬件相关操作
   
   底半部（延迟处理）：
   - 耗时处理
   - 可调度任务
   ```

#### 2. 中断处理策略

1. **中断合并**：
   ```
   多个中断请求 -> 合并处理 ->
   减少上下文切换 -> 提高效率
   ```

2. **中断负载均衡**：
   ```
   在多核系统中：
   中断请求 -> 分发器 -> CPU1
                     |-> CPU2
                     |-> CPU3
   ```

**思考题**

> 　　在设计一个实时系统时，如何保证关键中断的及时响应？需要考虑哪些因素？

## 小结

### 知识点

- 中断的基本概念和类型
- 中断处理的基本流程
- 中断向量表的组织
- 中断性能优化方法

### 思考题答案（仅供参考）

　　保证关键中断响应需考虑：

1. **优先级设计**：
   - 合理分配优先级
   - 关键中断最高优先级
   - 防止优先级反转

2. **中断延迟控制**：
   - 最小化关中断时间
   - 使用快速中断通道
   - 优化中断处理流程

3. **资源分配**：
   - 专用处理器核心
   - 独立中断控制器
   - 预留系统资源

4. **可靠性保证**：
   - 容错设计
   - 看门狗机制
   - 备份处理方案

## 参考资料

1. [Wikipedia(zh)：中断](https://zh.wikipedia.org/wiki/%E4%B8%AD%E6%96%B7_(%E8%A8%88%E7%AE%97%E6%A9%9F))：中断的基本概念
2. [Wikipedia(zh)：中断向量表](https://zh.wikipedia.org/wiki/%E4%B8%AD%E6%96%B7%E5%90%91%E9%87%8F%E8%A1%A8)：中断向量表的原理
3. [Wikipedia(zh)：实时操作系统](https://zh.wikipedia.org/wiki/%E5%AE%9E%E6%97%B6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F)：实时系统中的中断处理

## 协议

　　本作品采用[知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)进行许可。
